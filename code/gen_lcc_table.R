library(terra)

lc_name <- c('bryoids','shrubs','wetland','wetland_treed','herbs','coniferous','broadleaf','mixedwood')

x <- tibble(type=c('1984 only (loss)','2019 only (gain)','unchanged',
    'ifl2000_loss','ifl2000_gain','ifl2000_unchanged',
    'ifl2020_loss','ifl2020_gain','ifl2020_unchanged'), 
    bryoids = 0,
    shrubs = 0,
    wetland = 0,
    wetland_treed = 0,
    herbs = 0,
    coniferous = 0,
    broadleaf = 0,
    mixedwood = 0
    )
i2000 <- vect('gisdata/fda_10ab.gpkg', 'ifl_2000')
i2020 <- vect('gisdata/fda_10ab.gpkg', 'ifl_2020')
r1984 <- rast(paste0('gisdata/fda_10ab/lc1984_30m.tif'))
r2019 <- rast(paste0('gisdata/fda_10ab/lc2019_30m.tif'))
for (i in lc_name) {
    cat(i,'...\n'); flush.console()
    if (i=='bryoids') {
        r1 <- subst(r1984, c(0,20,31,32,33,40,50,80,81,100,210,220,230), c(0,0,0,0,0,1,0,0,0,0,0,0,0))
        r2 <- subst(r2019, c(0,20,31,32,33,40,50,80,81,100,210,220,230), c(0,0,0,0,0,2,0,0,0,0,0,0,0))
    } else if (i=='shrubs') {
        r1 <- subst(r1984, c(0,20,31,32,33,40,50,80,81,100,210,220,230), c(0,0,0,0,0,0,1,0,0,0,0,0,0))
        r2 <- subst(r2019, c(0,20,31,32,33,40,50,80,81,100,210,220,230), c(0,0,0,0,0,0,2,0,0,0,0,0,0))
    } else if (i=='wetland') {
        r1 <- subst(r1984, c(0,20,31,32,33,40,50,80,81,100,210,220,230), c(0,0,0,0,0,0,0,1,0,0,0,0,0))
        r2 <- subst(r2019, c(0,20,31,32,33,40,50,80,81,100,210,220,230), c(0,0,0,0,0,0,0,2,0,0,0,0,0))
    } else if (i=='wetland_treed') {
        r1 <- subst(r1984, c(0,20,31,32,33,40,50,80,81,100,210,220,230), c(0,0,0,0,0,0,0,0,1,0,0,0,0))
        r2 <- subst(r2019, c(0,20,31,32,33,40,50,80,81,100,210,220,230), c(0,0,0,0,0,0,0,0,2,0,0,0,0))
    } else if (i=='herbs') {
        r1 <- subst(r1984, c(0,20,31,32,33,40,50,80,81,100,210,220,230), c(0,0,0,0,0,0,0,0,0,1,0,0,0))
        r2 <- subst(r2019, c(0,20,31,32,33,40,50,80,81,100,210,220,230), c(0,0,0,0,0,0,0,0,0,2,0,0,0))
    } else if (i=='coniferous') {
        r1 <- subst(r1984, c(0,20,31,32,33,40,50,80,81,100,210,220,230), c(0,0,0,0,0,0,0,0,0,0,1,0,0))
        r2 <- subst(r2019, c(0,20,31,32,33,40,50,80,81,100,210,220,230), c(0,0,0,0,0,0,0,0,0,0,2,0,0))
    } else if (i=='broadleaf') {
        r1 <- subst(r1984, c(0,20,31,32,33,40,50,80,81,100,210,220,230), c(0,0,0,0,0,0,0,0,0,0,0,1,0))
        r2 <- subst(r2019, c(0,20,31,32,33,40,50,80,81,100,210,220,230), c(0,0,0,0,0,0,0,0,0,0,0,2,0))
    } else if (i=='mixedwood') {
        r1 <- subst(r1984, c(0,20,31,32,33,40,50,80,81,100,210,220,230), c(0,0,0,0,0,0,0,0,0,0,0,0,1))
        r2 <- subst(r2019, c(0,20,31,32,33,40,50,80,81,100,210,220,230), c(0,0,0,0,0,0,0,0,0,0,0,0,2))
    }
    r <- r1 + r2
    NAflag(r) <- 0
    v <- table(values(r))
    x[1,i] <- round(v[1]*30/10000,1)
    x[2,i] <- round(v[2]*30/10000,1)
    x[3,i] <- round(v[3]*30/10000,1)
    r2000 <- mask(r, i2000)
    v2000 <- table(values(r2000))
    x[4,i] <- round(v2000[1]*30/10000,1)
    x[5,i] <- round(v2000[2]*30/10000,1)
    x[6,i] <- round(v2000[3]*30/10000,1)
    r2020 <- mask(r, i2020)
    v2020 <- table(values(r2020))
    x[7,i] <- round(v2020[1]*30/10000,1)
    x[8,i] <- round(v2020[2]*30/10000,1)
    x[9,i] <- round(v2020[3]*30/10000,1)

}

write_csv(x, 'app/lcc.csv')
